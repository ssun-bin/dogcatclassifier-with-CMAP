<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <title>fastai2 /predict API Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; margin: 24px; line-height: 1.45; }
    h1 { margin: 0 0 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 16px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
    .row { display: flex; gap: 16px; align-items: center; flex-wrap: wrap; }
    .row > * { flex: 1 1 auto; }
    .btn { cursor: pointer; padding: 10px 14px; border-radius: 12px; border: 1px solid #e5e7eb; background: #fff; }
    .btn:hover { background: #f9fafb; }
    .out-img { max-width: 100%; border-radius: 12px; border: 1px solid #e5e7eb; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #e5e7eb; padding: 8px 10px; text-align: left; }
    th { background: #f9fafb; }
    .muted { color: #6b7280; font-size: 0.9rem; }
    .spinner { display: none; }
    .spinner.on { display: inline-block; }
    .footer { color: #9ca3af; font-size: 12px; margin-top: 8px; }
    .token { width: 100%; max-width: 420px; }
  </style>
</head>
<body>
  <h1>ğŸ¶ğŸ± fastai2 Grad-CAM & í™•ë¥  ë°ëª¨</h1>
  <p class="muted">ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí•˜ê³  <b>/predict</b> APIë¥¼ í˜¸ì¶œí•´ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”.</p>

  <div class="card">
    <div class="row">
      <div>
        <label>ì´ë¯¸ì§€ ì—…ë¡œë“œ</label><br />
        <input id="file" type="file" accept="image/*" />
      </div>
      <div>
        <label>Hugging Face Token (ë¹„ê³µê°œ Spaceì¼ ë•Œë§Œ)</label><br />
        <input id="token" class="token" type="password" placeholder="hf_xxx (ì˜µì…˜)" />
      </div>
      <div style="align-self:flex-end;">
        <button id="run" class="btn">/predict í˜¸ì¶œ</button>
        <span id="spin" class="spinner">â³ í˜¸ì¶œ ì¤‘â€¦</span>
      </div>
    </div>
  </div>

  <div class="card">
    <h3>â‘  Grad-CAM Heatmap</h3>
    <img id="heatmap" class="out-img" alt="Grad-CAM Heatmap will appear here" />
  </div>

  <div class="card">
    <h3>â‘¡ í´ë˜ìŠ¤ë³„ í™•ë¥ </h3>
    <table id="probs">
      <thead><tr><th>í´ë˜ìŠ¤</th><th>í™•ë¥ </th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="footer">ëª¨ë¸ ì¶œë ¥ í˜•ì‹ì— ë”°ë¼ JSON â†’ í‘œ ë³€í™˜ ë¡œì§ì´ ì•½ê°„ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
  </div>

  <!-- ESM: @gradio/client from jsDelivr -->
  <script type="module">
    import { Client } from "https://cdn.jsdelivr.net/npm/@gradio/client/+esm";

    const $ = (sel) => document.querySelector(sel);
    const btn = $("#run");
    const spin = $("#spin");
    const imgEl = $("#heatmap");
    const tbody = $("#probs tbody");

    function setLoading(on) {
      if (on) {
        btn.disabled = true;
        spin.classList.add("on");
      } else {
        btn.disabled = false;
        spin.classList.remove("on");
      }
    }

    function clearOutputs() {
      imgEl.src = "";
      tbody.innerHTML = "";
    }

    function blobOrDataUrlFrom(any) {
      // Gradio client ë¸Œë¼ìš°ì € ë°˜í™˜ í˜•ì‹: Blob ë˜ëŠ” { url | path | data } ë“±ì¼ ìˆ˜ ìˆìŒ.
      if (!any) return null;
      // Blob ì§ì ‘ ë°˜í™˜ë˜ëŠ” ê²½ìš°:
      if (any instanceof Blob) return URL.createObjectURL(any);
      // ê°ì²´ì¸ ê²½ìš°: { url } ë˜ëŠ” { path } ë˜ëŠ” { data: "data:image/png;base64,..." }
      if (typeof any === "object") {
        if (any.url) return any.url;
        if (any.path) return any.path;
        if (any.data && typeof any.data === "string") return any.data; // data URL
      }
      // ë¬¸ìì—´ì¸ ê²½ìš°: data URL ë˜ëŠ” ì ˆëŒ€ URLë¡œ ê°€ì •
      if (typeof any === "string") return any;
      return null;
    }

    function renderProbabilities(val) {
      // Label ì»´í¬ë„ŒíŠ¸ ë°˜í™˜ì€ ë³´í†µ { label: "Cat", confidences: [{label, confidence}, ...] } ë˜ëŠ”
      // ë‹¨ìˆœ dict í˜•íƒœ { Cat: 0.98, Dog: 0.02 } ë“± ë‹¤ì–‘í•  ìˆ˜ ìˆìŒ â†’ ë‘˜ ë‹¤ ì²˜ë¦¬
      tbody.innerHTML = "";

      if (!val) return;

      let entries = [];
      if (val.confidences && Array.isArray(val.confidences)) {
        entries = val.confidences.map(({ label, confidence }) => [label, confidence]);
      } else if (typeof val === "object") {
        entries = Object.entries(val);
      } else {
        // ì•Œ ìˆ˜ ì—†ëŠ” í¬ë§· â†’ ë¬¸ìì—´ë¡œ í‘œì‹œ
        const tr = document.createElement("tr");
        tr.innerHTML = `<td colspan="2"><code>${String(val)}</code></td>`;
        tbody.appendChild(tr);
        return;
      }

      // í™•ë¥  ë‚´ë¦¼ì°¨ìˆœ ì •ë ¬
      entries.sort((a, b) => Number(b[1]) - Number(a[1]));
      for (const [label, prob] of entries) {
        const tr = document.createElement("tr");
        const pct = (Number(prob) * 100).toFixed(2) + "%";
        tr.innerHTML = `<td>${label}</td><td>${pct}</td>`;
        tbody.appendChild(tr);
      }
    }

    btn.addEventListener("click", async () => {
      clearOutputs();
      const file = $("#file").files?.[0];
      const token = $("#token").value.trim();

      if (!file) {
        alert("ì´ë¯¸ì§€ íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
        return;
      }

      setLoading(true);
      try {
        // Space ì—°ê²° (ë¹„ê³µê°œì´ë©´ hf_token ì „ë‹¬)
        const client = await Client.connect("ssunbin/fastai2", token ? { hf_token: token } : undefined);

        // /predict í˜¸ì¶œ: ì»´í¬ë„ŒíŠ¸ ëª…ì„¸ì— ë”°ë¼ keyëŠ” "img"
        const result = await client.predict("/predict", { img: file });

        // result.dataëŠ” [ heatmap, label_probs ] í˜•ì‹
        const [heatmap, probs] = result?.data ?? [];

        // â‘  ì´ë¯¸ì§€ ë Œë”
        const heatmapUrl = blobOrDataUrlFrom(heatmap);
        if (heatmapUrl) imgEl.src = heatmapUrl;

        // â‘¡ í™•ë¥  í‘œ ë Œë”
        renderProbabilities(probs);

      } catch (err) {
        console.error(err);
        alert("ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì½˜ì†”ì„ í™•ì¸í•˜ì„¸ìš”.");
      } finally {
        setLoading(false);
      }
    });
  </script>

  <p class="footer">
    ë¡œì»¬ íŒŒì¼ë¡œ ì—´ë©´ ëª¨ë“ˆ/íŒŒì¼ ì ‘ê·¼ ì •ì±… ë•Œë¬¸ì— ë§‰í ìˆ˜ ìˆìŠµë‹ˆë‹¤. <code>python -m http.server 8000</code> ë“±ìœ¼ë¡œ
    ê°„ë‹¨ ì„œë²„ë¥¼ ë„ì›Œ <a href="http://localhost:8000" target="_blank">http://localhost:8000</a> ë¡œ ì ‘ì†í•˜ì„¸ìš”.
  </p>
</body>
</html>
